<!DOCTYPE html>
<html lang="pt-BR" xmlns:mso="urn:schemas-microsoft-com:office:office" xmlns:msdt="uuid:C2F41010-65B3-11d1-A29F-00AA00C14882">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sonar</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'style.css' %}">

<!--[if gte mso 9]><xml>
<mso:CustomDocumentProperties>
<mso:_ApprovalStatus msdt:dt="string">0</mso:_ApprovalStatus>
<mso:_ApprovalAssignedTo msdt:dt="string"></mso:_ApprovalAssignedTo>
<mso:_ApprovalRespondedBy msdt:dt="string"></mso:_ApprovalRespondedBy>
</mso:CustomDocumentProperties>
</xml><![endif]-->
</head>
<body>

    <header>
        
    <div class="header-navbar__content">

        <div class="header-navbar__content-logo">
            <div class="sidebar-toggle desktop-only">
                 <button abrir-menu>
                    <i>üêü</i>
                </button>
            </div>
            <div class="navbar-logo">
                <a href="/"><strong>Sonar</strong></a>
            </div>
        </div>

        <form action="{% url 'busca' %}" method="GET" class="search-container">
            <input type="text" name="q" id="search-input" placeholder="Pesquisar..." class="search-input" autocomplete="off">
            <button type="submit" class="search-btn">
                <span class="material-symbols-outlined">search</span>
            </button>
            <div id="live-search-results" class="search-dropdown"></div>
        </form>

        <div class="header-navbar__content-barra desktop-only" data-component="user-auth">
            <div>
                <a href="{% url 'metodologia' %}" class="header-navbar__btn"><strong>Metodologia</strong></a>
            </div>
            <div>
                <a href="{% url 'sobre' %}" class="header-navbar__btn"><strong>Sobre</strong></a>
            </div>
            
            {% if user.is_authenticated %}
                <div>
                    <a href="{% url 'perfil' %}" class="header-navbar__btn"><strong>Minha Conta</strong></a>
                </div>
            {% else %}
                <div>
                    <a href="{% url 'login' %}" class="header-navbar__btn"><strong>Entrar</strong></a>
                </div>
            {% endif %}
        </div>

        <div class="mobile-profile-trigger mobile-only">
            <button abrir-menu class="btn-perfil-mobile">
                {% if user.is_authenticated %}
                    <span class="material-symbols-outlined" style="font-size: 32px; color: var(--accent-color);">account_circle</span>
                {% else %}
                    <span class="material-symbols-outlined" style="font-size: 32px; color: #fff;">login</span>
                {% endif %}
            </button>
        </div>

    </div>

    <div id="sidebar-menu" class="sidebar-menu"> 
        <aside class="sidebar-menu__wrapper"> 
            <div class="sidebar-menu__container">
                <div class="main-menu">
                    
                    <div class="mobile-only" style="margin-bottom: 20px; text-align: center;">
                        <h2 style="color: var(--accent-color);">Menu</h2>
                    </div>

                    <a href="/" class="main-menu__item">
                        <span class="material-symbols-outlined">home</span> In√≠cio
                    </a>

                    <a href="{% url 'metodologia' %}" class="main-menu__item mobile-only">
                        <span class="material-symbols-outlined">menu_book</span> Metodologia
                    </a>
                    <a href="{% url 'sobre' %}" class="main-menu__item mobile-only">
                        <span class="material-symbols-outlined">info</span> Sobre
                    </a>

                    {% if user.is_authenticated %}
                        <a href="{% url 'perfil' %}" class="main-menu__item mobile-only">
                            <span class="material-symbols-outlined">person</span> Minha Conta
                        </a>
                         <a href="{% url 'logout' %}" class="main-menu__item mobile-only" style="color: #ff6b6b;">
                            <span class="material-symbols-outlined">logout</span> Sair
                        </a>
                    {% else %}
                        <a href="{% url 'login' %}" class="main-menu__item mobile-only">
                            <span class="material-symbols-outlined">login</span> Entrar
                        </a>
                    {% endif %}
                    
                    <div class="separador"></div>
                    <div style="padding-left: 16px; margin-bottom: 8px; font-size: 12px; color: #888; text-transform: uppercase; font-weight: bold;">Navega√ß√£o R√°pida</div>

                    {% for div in sidebar_divergencias %}
                        <a href="{% url 'divergencias' div.slug %}" class="main-menu__item">
                            {{ div.nome }}
                        </a>
                    {% empty %}
                        {% endfor %}

                    <div class="separador"></div>
                    <a href="{% url 'contato' %}" class="main-menu__item">Contato</a>
                </div>
            </div>
        </aside>
        
        <div class="sidebar-footer">
            <div class="footer-copyright">¬© 2025 Projeto Sonar</div>
        </div>
    </div>
    <div id="sidebar-overlay" class="sidebar-overlay"></div>
</header>

    <main id="main">
        {% block conteudo %}
        {% endblock %}
    </main>

    <script>
        // --- BLOQUEIO DO BOT√ÉO VOLTAR NA HOME ---
        // Se a url for apenas "/" (Home), impede de voltar
        if (window.location.pathname === '/') {
            // Cria um estado no hist√≥rico para "prender" o usu√°rio
            history.pushState(null, null, window.location.href);
            
            // Sempre que ele tentar voltar (clicar no bot√£o do mouse ou do navegador)
            window.addEventListener('popstate', function () {
                // Empurra ele de volta para a p√°gina atual
                history.pushState(null, null, window.location.href);
            });
        }

        document.addEventListener("DOMContentLoaded", function() {
            // 1. Seleciona os elementos
            const botoes = document.querySelectorAll('[abrir-menu]');
            const menu = document.getElementById("sidebar-menu");
            const overlay = document.getElementById("sidebar-overlay");
            const main = document.getElementById("main");

            // --- L√ìGICA DE PERSIST√äNCIA (Local Storage) ---

            // Fun√ß√£o para aplicar o estado (Abrir ou Fechar)
            function setMenuState(isOpen, animate = true) {
                if (!animate) {
                    menu.style.transition = 'none';
                    main.style.transition = 'none';
                    overlay.style.transition = 'none';
                }

                if (isOpen) {
                    menu.classList.add('is-open');
                    overlay.classList.add('is-open');
                    main.classList.add('is-open');
                } else {
                    menu.classList.remove('is-open');
                    overlay.classList.remove('is-open');
                    main.classList.remove('is-open');
                }

                localStorage.setItem('sidebarAberta', isOpen);

                if (!animate) {
                    void menu.offsetWidth; 
                    setTimeout(() => {
                        menu.style.transition = '';
                        main.style.transition = '';
                        overlay.style.transition = '';
                    }, 50);
                }
            }

            // 2. Verifica se j√° estava aberto antes
            const estadoSalvo = localStorage.getItem('sidebarAberta') === 'true';
            
            if (estadoSalvo) {
                setMenuState(true, false); 
            }

            // --- EVENTOS DE CLIQUE ---

            // 3. Clique nos bot√µes de abrir/fechar
            botoes.forEach(botao => {
                botao.addEventListener('click', () => {
                    const isCurrentlyOpen = menu.classList.contains('is-open');
                    setMenuState(!isCurrentlyOpen, true); 
                });
            });

            // 4. Clique no Overlay para fechar
            if (overlay) {
                overlay.addEventListener('click', () => {
                    setMenuState(false, true);
                });
            }

            // --- L√ìGICA DE LOGIN ---
            const component = document.querySelector('[data-component="user-auth"]');
            if (component) {
                const loginTarget = component.querySelector('[data-target="loginButton"]');
                const menuTarget = component.querySelector('[data-target="userMenu"]');
                const usuarioEstaLogado = true; // Mude para testar

                if (usuarioEstaLogado) {
                    if(loginTarget) loginTarget.style.display = 'none';
                    if(menuTarget) menuTarget.style.display = 'block';
                } else {
                    if(loginTarget) loginTarget.style.display = 'block';
                    if(menuTarget) menuTarget.style.display = 'none';
                }
            }
        });
    </script>

    <div id="modal-preview-global" class="modal-overlay" style="display: none;">
    <div class="modal-conteudo" style="display: flex; flex-direction: column; height: 90vh; width: 90vw; max-width: 1200px;">
        
        <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; border-bottom: 1px solid #eee;">
            <div>
                <h3 id="modal-titulo-texto" style="margin: 0; color: #333;">Visualizar Arquivo</h3>
            </div>
            <div style="display: flex; gap: 15px; align-items: center;">
                <a id="modal-btn-baixar" href="#" download class="btn-baixar" style="background: var(--accent-color); color: #fff; padding: 8px 20px; font-size: 14px;">
                    Baixar Agora
                </a>
                <span class="fechar-modal" onclick="fecharModalPreview()" style="font-size: 30px; cursor: pointer;">&times;</span>
            </div>
        </div>

        <div style="flex: 1; background: #e5e5e5; margin-top: 15px; border-radius: 8px; overflow: hidden;">
            <iframe id="modal-iframe" src="" width="100%" height="100%" style="border: none;"></iframe>
        </div>

    </div>
</div>

<script>
    // --- FUN√á√ïES GLOBAIS DO MODAL ---
    function abrirModalPreview(urlArquivo, tituloArquivo) {
        const modal = document.getElementById('modal-preview-global');
        if(modal) {
            document.getElementById('modal-iframe').src = urlArquivo;
            document.getElementById('modal-titulo-texto').innerText = tituloArquivo;
            document.getElementById('modal-btn-baixar').href = urlArquivo;
            modal.style.display = 'flex';
        }
    }

    function fecharModalPreview() {
        const modal = document.getElementById('modal-preview-global');
        if(modal) {
            modal.style.display = 'none';
            document.getElementById('modal-iframe').src = '';
        }
    }

    // Fechar ao clicar fora
    const modalEl = document.getElementById('modal-preview-global');
    if(modalEl){
        modalEl.addEventListener('click', function(e) {
            if (e.target === this) fecharModalPreview();
        });
    }

    // --- L√ìGICA DA BARRA DE PESQUISA ---
    document.addEventListener('DOMContentLoaded', function() {
        const input = document.getElementById('search-input');
        const resultsBox = document.getElementById('live-search-results');
        const searchContainer = document.querySelector('.search-container');
        let timeout = null;

        if (input) {
            input.addEventListener('input', function() {
                const query = this.value.trim();
                clearTimeout(timeout); 

                if (query.length === 0) {
                    fecharDropdown();
                    return;
                }

                timeout = setTimeout(() => {
                    fetch(`/busca-live/?q=${encodeURIComponent(query)}`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error("Erro no servidor (verifique urls.py)");
                            }
                            return response.json();
                        })
                        .then(data => {
                            let html = '';
                            
                            // Verifica se veio alguma coisa
                            const temDivergencia = data.divergencias && data.divergencias.length > 0;
                            const temMateria = data.materias && data.materias.length > 0;
                            const temPdf = data.pdfs && data.pdfs.length > 0;

                            if (!temDivergencia && !temMateria && !temPdf) {
                                resultsBox.innerHTML = '<div class="search-result-item" style="color: #aaa; text-align: center; padding: 15px;">Nenhum resultado encontrado.</div>';
                                abrirDropdown();
                                return;
                            }

                            // 1. SE√á√ÉO DIVERG√äNCIAS
                            if (temDivergencia) {
                                html += '<div class="search-category-title">Diverg√™ncias</div>';
                                data.divergencias.forEach(item => {
                                    html += `<a href="${item.url}" class="search-result-item"><strong>${item.nome}</strong></a>`;
                                });
                            }

                            // 2. SE√á√ÉO MAT√âRIAS
                            if (temMateria) {
                                html += '<div class="search-category-title">Mat√©rias</div>';
                                data.materias.forEach(item => {
                                    html += `
                                        <a href="${item.url}" class="search-result-item" style="display: flex; justify-content: space-between; align-items: center;">
                                            <div>
                                                <span style="font-weight: bold; color: #fff;">üìö ${item.nome}</span>
                                                <small style="display: block; color: var(--accent-color);">${item.info}</small>
                                            </div>
                                            <span class="material-symbols-outlined" style="font-size: 16px; color: #aaa;">arrow_forward</span>
                                        </a>`;
                                });
                            }

                            // 3. SE√á√ÉO PDFs
                            if (temPdf) {
                                html += '<div class="search-category-title">Arquivos PDF</div>';
                                data.pdfs.forEach(item => {
                                    // Aten√ß√£o: Usamos aspas simples escapadas nos argumentos da fun√ß√£o
                                    html += `
                                        <div class="search-result-item" style="cursor: pointer;" 
                                             onclick="abrirModalPreview('${item.url_arquivo}', '${item.titulo}')">
                                            üìÑ ${item.titulo}
                                            <small style="display:block; color: #94a3b8;">${item.info}</small>
                                        </div>`;
                                });
                            }

                            resultsBox.innerHTML = html;
                            abrirDropdown();
                        })
                        .catch(error => {
                            console.error("Erro na busca:", error);
                            resultsBox.innerHTML = '<div class="search-result-item" style="color: #ff6b6b; text-align: center;">Erro ao buscar. Verifique o console.</div>';
                            abrirDropdown();
                        });
                }, 300);
            });
        }

        function abrirDropdown() {
            resultsBox.classList.add('active');
            if(searchContainer) {
                searchContainer.style.borderRadius = '20px 20px 0 0';
                searchContainer.style.backgroundColor = 'rgba(15, 23, 42, 0.95)';
            }
        }

        function fecharDropdown() {
            resultsBox.classList.remove('active');
            if(searchContainer) {
                searchContainer.style.borderRadius = '50px';
                searchContainer.style.backgroundColor = '';
            }
        }

        // Fechar ao clicar fora
        document.addEventListener('click', function(e) {
            if (searchContainer && !searchContainer.contains(e.target)) {
                fecharDropdown();
            }
        });
    });
</script>

</body>
</html>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" 
integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>