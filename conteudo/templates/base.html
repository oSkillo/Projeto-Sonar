<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sonar</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'style.css' %}">
</head>
<body>

{% block mensagens_globais %}
    {% if messages %}
        <div class="toast-container">
            {% for message in messages %}
                <div class="toast {{ message.tags }}">
                    <span>{{ message }}</span>
                    <button onclick="this.parentElement.remove()" class="toast-close">Ã—</button>
                </div>
            {% endfor %}
        </div>
    {% endif %}
{% endblock %}
{% if user.is_authenticated %}
    <header id="site-header">
        <div class="header-navbar__content">

            <div class="header-navbar__content-logo">
                
                <button type="button" class="mobile-menu-toggle" id="mobile-menu-btn" abrir-menu="">
                    <span class="material-symbols-outlined">menu</span>
                </button>

                <div class="sidebar-toggle display-desktop">
                    <button abrir-menu=""> 
                        <img src="{% static 'img/icone-Sonar.png' %}" class="icon-img-custom" alt="Menu">
                    </button>
                </div>
                
                <div class="navbar-logo">
                    <a href="/">
                        <strong class="logo-text">Sonar</strong>
                        <img src="{% static 'img/icone-Sonar.png' %}" class="logo-icon-mini-img" alt="Sonar">
                    </a>
                </div>
            </div>

            <form action="{% url 'busca' %}" method="GET" class="search-container" id="search-form-container">
                <button type="button" id="close-search-mobile" class="close-search-btn">âœ•</button>
                <input type="text" name="q" id="search-input" placeholder="Pesquisar..." class="search-input" autocomplete="off">
                <button type="submit" class="search-btn">
                    <span class="material-symbols-outlined">search</span>
                </button>
                <div id="live-search-results" class="search-dropdown"></div>
            </form>

            <button type="button" id="mobile-search-trigger" class="mobile-search-trigger">
                <span class="material-symbols-outlined">search</span>
            </button>

            <div class="header-navbar__content-barra">
                
                <div class="botoes-desktop">
                    <div class="esconder-cedo">
                        <a href="{% url 'metodologia' %}" class="header-navbar__btn">Metodologia</a>
                    </div>
                    <div class="esconder-cedo">
                        <a href="{% url 'sobre' %}" class="header-navbar__btn">Sobre</a>
                    </div>

                    {% if user.is_authenticated %}
                        <div>
                            <a href="{% url 'perfil_usuario' %}" class="nav-user-card" title="Ir para meu perfil">
                                <span class="nav-user-name">
                                    OlÃ¡, {{ user.first_name|default:user.username }}
                                </span>
                                <img src="{{ user.perfil.foto.url }}" alt="Perfil" class="nav-profile-img-large">
                            </a>
                        </div>
                    {% else %}
                        <div>
                            <a href="{% url 'login' %}" class="header-navbar__btn btn-destaque">
                                Entrar
                            </a>
                        </div>
                    {% endif %}
                </div>

                <div class="mobile-emoji-decorative mobile-profile-container">
                    {% if user.is_authenticated %}
                        <a href="{% url 'perfil_usuario' %}">
                            <img src="{{ user.perfil.foto.url }}" alt="Perfil" class="nav-profile-img" style="width: 50px; height: 50px;">
                        </a>
                    {% else %}
                        <a href="{% url 'sair' %}" style="text-decoration: none; font-size: 24px;">ðŸŸ </a>
                    {% endif %}
                </div>
            </div>
 
        <div id="sidebar-overlay" class="sidebar-overlay"></div>
    </header>

    <div id="sidebar-menu" class="sidebar-menu"> 
                <aside class="sidebar-menu__wrapper"> 
                    <div class="sidebar-menu__container">
                        <div class="main-menu">
                            <a href="/" class="main-menu__item" style="text-decoration: none; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">InÃ­cio</a>
                            <div class="grupo-institucional sidebar-hidden-default">
                                <div class="separador"></div>
                                <div style="padding-left: 16px; font-size: 12px; color: #888; font-weight: bold;">INSTITUCIONAL</div>
                                <br>
                                <a href="{% url 'metodologia' %}" class="main-menu__item" style="text-decoration: none; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">Metodologia</a>
                                <a href="{% url 'sobre' %}" class="main-menu__item" style="text-decoration: none; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">Sobre</a>
                            </div>
                            <div class="grupo-conta sidebar-hidden-default">
                                <a href="#" class="main-menu__item" style="text-decoration: none; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">Minha Conta</a>
                            </div>
                            <div class="separador"></div>
                            <div style="padding-left: 16px; margin-bottom: 8px; font-size: 12px; color: #888; text-transform: uppercase; font-weight: bold;">NavegaÃ§Ã£o RÃ¡pida</div>
                            {% for div in sidebar_divergencias %}
                                <a href="{% url 'divergencias' div.slug %}" class="main-menu__item" style="text-decoration: none; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
                                    {{ div.nome }}
                                </a>
                            {% empty %}{% endfor %}

                            <a href="{% url 'outras' %}" class="main-menu__item" style="text-decoration: none; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
                                <span class="material-symbols-outlined" style="font-size: 20px; margin-right: 10px; vertical-align: middle;" title="Outras DivergÃªncias">ðŸ§¬</span>
                                Outras DivergÃªncias
                            </a>
                            <div class="separador"></div>
                            <a href="{% url 'perfil_usuario' %}" class="main-menu__item" style="text-decoration: none; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">Perfil</a>
                            <a href="{% url 'contato' %}" class="main-menu__item" style="text-decoration: none; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">Contato</a>
                        </div>
                    </div>
                </aside>
                <div class="sidebar-footer">
                    <div class="footer-links">
                        <a href="/sobre/">Sobre</a>   
                        <a href="#">Imprensa</a>
                        <a href="#">Direitos autorais</a>
                        <a href="#">Entre em contato</a>
                        <a href="#">Criadores</a>
                        <a href="#">Desenvolvedores</a>
                    </div>
                    <div class="footer-links">
                        <a href="#">Termos</a>
                        <a href="#">Privacidade</a>
                        <a href="#">PolÃ­tica e SeguranÃ§a</a>
                        <a href="/metodologia/">Como funciona o Sonar</a>
                    </div>
                    <div class="footer-copyright">Â© 2025 Projeto Sonar</div>
                </div>
            </div>
{% endif %}
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />

    <main id="main">
        {% block conteudo %}
        {% endblock %}
    </main>
{% if user.is_authenticated %}
    <script>
        if (window.location.pathname === '/') {
            history.pushState(null, null, window.location.href);
            window.addEventListener('popstate', function () {
                history.pushState(null, null, window.location.href);
            });
        }

        document.addEventListener("DOMContentLoaded", function() {
            const botoes = document.querySelectorAll('[abrir-menu]');
            const menu = document.getElementById("sidebar-menu");
            const overlay = document.getElementById("sidebar-overlay");
            const main = document.getElementById("main");

            function setMenuState(isOpen, animate = true) {
                if (!animate) {
                    menu.style.transition = 'none';
                    main.style.transition = 'none';
                    overlay.style.transition = 'none';
                }

                if (isOpen) {
                    menu.classList.add('is-open');
                    overlay.classList.add('is-open');
                    main.classList.add('is-open');
                    if (window.innerWidth < 1600) {
                        document.body.classList.add('no-scroll'); 
                    }
                } else {
                    menu.classList.remove('is-open');
                    overlay.classList.remove('is-open');
                    main.classList.remove('is-open');
                    document.body.classList.remove('no-scroll');
                }

                localStorage.setItem('sidebarAberta', isOpen);

                if (!animate) {
                    void menu.offsetWidth; 
                    setTimeout(() => {
                        menu.style.transition = '';
                        main.style.transition = '';
                        overlay.style.transition = '';
                    }, 50);
                }
            }

            window.addEventListener('resize', function() {
                const menuEstaAberto = document.getElementById("sidebar-menu").classList.contains('is-open');
                
                if (menuEstaAberto) {
                    if (window.innerWidth >= 1600) {
                        document.body.classList.remove('no-scroll');
                    } else {
                        document.body.classList.add('no-scroll');
                    }
                }
            });

            const estadoSalvo = localStorage.getItem('sidebarAberta') === 'true';
            
            if (estadoSalvo) {
                setMenuState(true, false); 
            }

            botoes.forEach(botao => {
                botao.addEventListener('click', () => {
                    const isCurrentlyOpen = menu.classList.contains('is-open');
                    setMenuState(!isCurrentlyOpen, true); 
                });
            });

            if (overlay) {
                overlay.addEventListener('click', () => {
                    setMenuState(false, true);
                });
            }


        });
    </script>
{% endif %}
<script>
    // --- FUNÃ‡Ã•ES GLOBAIS DO MODAL ---
    function abrirModalPreview(urlArquivo, tituloArquivo) {
        const modal = document.getElementById('modal-preview-global');
        if(modal) {
            document.getElementById('modal-iframe').src = urlArquivo;
            document.getElementById('modal-titulo-texto').innerText = tituloArquivo;
            document.getElementById('modal-btn-baixar').href = urlArquivo;
            modal.style.display = 'flex';
        }
    }

    function fecharModalPreview() {
        const modal = document.getElementById('modal-preview-global');
        if(modal) {
            modal.style.display = 'none';
            document.getElementById('modal-iframe').src = '';
        }
    }

    // Fechar ao clicar fora
    const modalEl = document.getElementById('modal-preview-global');
    if(modalEl){
        modalEl.addEventListener('click', function(e) {
            if (e.target === this) fecharModalPreview();
        });
    }

    // --- LÃ“GICA DA BARRA DE PESQUISA ---
    document.addEventListener('DOMContentLoaded', function() {
        const input = document.getElementById('search-input');
        const resultsBox = document.getElementById('live-search-results');
        const searchContainer = document.querySelector('.search-container');
        let timeout = null;

        if (input) {
            input.addEventListener('input', function() {
                const query = this.value.trim();
                clearTimeout(timeout); 

                if (query.length === 0) {
                    fecharDropdown();
                    return;
                }

                timeout = setTimeout(() => {
                    fetch(`/busca-live/?q=${encodeURIComponent(query)}`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error("Erro no servidor (verifique urls.py)");
                            }
                            return response.json();
                        })
                        .then(data => {
                            let html = '';
                            
                            // Verifica se veio alguma coisa
                            const temDivergencia = data.divergencias && data.divergencias.length > 0;
                            const temMateria = data.materias && data.materias.length > 0;
                            const temPdf = data.pdfs && data.pdfs.length > 0;

                            if (!temDivergencia && !temMateria && !temPdf) {
                                resultsBox.innerHTML = '<div class="search-result-item" style="color: #aaa; text-align: center; padding: 15px;">Nenhum resultado encontrado.</div>';
                                abrirDropdown();
                                return;
                            }

                            // 1. SEÃ‡ÃƒO DIVERGÃŠNCIAS
                            if (temDivergencia) {
                                html += '<div class="search-category-title">DivergÃªncias</div>';
                                data.divergencias.forEach(item => {
                                    html += `<a href="${item.url}" class="search-result-item"><strong>${item.nome}</strong></a>`;
                                });
                            }

                            // 2. SEÃ‡ÃƒO MATÃ‰RIAS
                            if (temMateria) {
                                html += '<div class="search-category-title">MatÃ©rias</div>';
                                data.materias.forEach(item => {
                                    html += `
                                        <a href="${item.url}" class="search-result-item" style="display: flex; justify-content: space-between; align-items: center;">
                                            <div>
                                                <span style="font-weight: bold; color: #fff;">ðŸ“š ${item.nome}</span>
                                                <small style="display: block; color: var(--accent-color);">${item.info}</small>
                                            </div>
                                            <span class="material-symbols-outlined" style="font-size: 16px; color: #aaa;">arrow_forward</span>
                                        </a>`;
                                });
                            }

                            // 3. SEÃ‡ÃƒO PDFs
                            if (temPdf) {
                                html += '<div class="search-category-title">Arquivos PDF</div>';
                                data.pdfs.forEach(item => {
                                    // AtenÃ§Ã£o: Usamos aspas simples escapadas nos argumentos da funÃ§Ã£o
                                    html += `
                                        <div class="search-result-item" style="cursor: pointer;" 
                                             onclick="abrirModalPreview('${item.url_arquivo}', '${item.titulo}')">
                                            ðŸ“„ ${item.titulo}
                                            <small style="display:block; color: #94a3b8;">${item.info}</small>
                                        </div>`;
                                });
                            }

                            resultsBox.innerHTML = html;
                            abrirDropdown();
                        })
                        .catch(error => {
                            console.error("Erro na busca:", error);
                            resultsBox.innerHTML = '<div class="search-result-item" style="color: #ff6b6b; text-align: center;">Erro ao buscar. Verifique o console.</div>';
                            abrirDropdown();
                        });
                }, 300);
            });
        }

        function abrirDropdown() {
            resultsBox.classList.add('active');
            if(searchContainer) {
                searchContainer.style.borderRadius = '20px 20px 0 0';
                searchContainer.style.backgroundColor = 'rgba(15, 23, 42, 0.95)';
            }
        }

        function fecharDropdown() {
            resultsBox.classList.remove('active');
            if(searchContainer) {
                searchContainer.style.borderRadius = '50px';
                searchContainer.style.backgroundColor = '';
            }
        }

        // Fechar ao clicar fora
        document.addEventListener('click', function(e) {
            if (searchContainer && !searchContainer.contains(e.target)) {
                fecharDropdown();
            }
        });
    });

    document.addEventListener("DOMContentLoaded", function() {
        const mobileTrigger = document.getElementById('mobile-search-trigger');
        const searchForm = document.getElementById('search-form-container');
        const closeBtn = document.getElementById('close-search-mobile');
        const input = document.getElementById('search-input');
        
        // Selecionamos o container principal da navbar para controlar os outros elementos
        const navbarContent = document.querySelector('.header-navbar__content');

        // FUNÃ‡ÃƒO ABRIR
        mobileTrigger.addEventListener('click', function() {
            // Adiciona classe na busca
            searchForm.classList.add('mobile-active');
            // Adiciona classe no pai para esconder o resto
            navbarContent.classList.add('busca-aberta');
            
            input.focus(); 
        });

        // FUNÃ‡ÃƒO FECHAR
        function fecharBusca() {
            searchForm.classList.remove('mobile-active');
            navbarContent.classList.remove('busca-aberta');
        }

        closeBtn.addEventListener('click', fecharBusca);

        // Fechar clicando fora (opcional)
        document.addEventListener('click', function(event) {
            const isClickInside = searchForm.contains(event.target) || mobileTrigger.contains(event.target);
            if (!isClickInside && window.innerWidth < 470 && searchForm.classList.contains('mobile-active')) {
                fecharBusca();
            }
        });
    });
</script>

<script>
    // --- BLOQUEIO DE DUPLO CLIQUE (Dedo Nervoso) ---
    document.addEventListener("DOMContentLoaded", function() {
        // Pega todos os formulÃ¡rios do site
        const forms = document.querySelectorAll('form');
        
        forms.forEach(form => {
            form.addEventListener('submit', function(e) {
                // Checa se o formulÃ¡rio estÃ¡ vÃ¡lido (campos obrigatÃ³rios preenchidos)
                if (!this.checkValidity()) {
                    return; // Se estiver invÃ¡lido, nÃ£o bloqueia o botÃ£o e deixa o navegador avisar
                }

                const btn = this.querySelector('button[type="submit"]');
                
                if (btn) {
                    // 1. Muda o visual para parecer travado
                    btn.style.opacity = '0.7';
                    btn.style.cursor = 'not-allowed';
                    
                    // 2. Muda o texto para dar feedback (opcional, se quiser manter sÃ³ o Ã­cone tire essa parte)
                    // Verifica se o botÃ£o tem texto antes de mudar
                    if (btn.innerText.trim().length > 0) {
                        btn.innerText = 'Salvando...';
                    }

                    // 3. Trava o clique (O Pulo do Gato)
                    // Pequeno delay para garantir que o formulÃ¡rio seja enviado antes de travar
                    setTimeout(() => {
                        btn.disabled = true;
                    }, 10);
                }
            });
        });
    });
</script>


    <div id="modal-preview-global" class="modal-overlay" style="display: none;">
        <div class="modal-conteudo">
            <span class="fechar-modal" onclick="fecharModalPreview()">Ã—</span>
            
            <div style="margin-bottom: 15px; padding-right: 30px;">
                <h3 id="modal-titulo-texto" style="margin: 0; color: #333; font-size: 1.2rem;">VisualizaÃ§Ã£o</h3>
            </div>
            
            <iframe id="modal-iframe" src="" style="width: 100%; height: calc(100% - 80px); border: none; border-radius: 4px; background: #f1f1f1;"></iframe>
            
            <div style="position: absolute; bottom: 20px; right: 20px;">
                <a id="modal-btn-baixar" href="" download class="btn-baixar">
                    Baixar PDF
                </a>
            </div>
        </div>
    </div>
    </body>
</html>