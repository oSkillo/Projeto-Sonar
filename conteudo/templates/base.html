<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sonar</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'style.css' %}">
</head>
<body>

    <header id="site-header">
        <div class="header-navbar__content">

            <div class="header-navbar__content-logo">
                
                <button type="button" class="mobile-menu-toggle" id="mobile-menu-btn" abrir-menu="">
                    <span class="material-symbols-outlined">menu</span>
                </button>

                <div class="sidebar-toggle display-desktop">
                    <button abrir-menu=""> 
                        <i>üêü</i>
                    </button>
                </div>
                
                <div class="navbar-logo">
                    <a href="/">
                        <strong class="logo-text">Sonar</strong>
                        <span class="logo-icon-mini">üêü</span>
                    </a>
                </div>
            </div>

            <form action="{% url 'busca' %}" method="GET" class="search-container" id="search-form-container">
                <button type="button" id="close-search-mobile" class="close-search-btn">‚úï</button>
                <input type="text" name="q" id="search-input" placeholder="Pesquisar..." class="search-input" autocomplete="off">
                <button type="submit" class="search-btn">
                    <span class="material-symbols-outlined">search</span>
                </button>
                <div id="live-search-results" class="search-dropdown"></div>
            </form>

            <button type="button" id="mobile-search-trigger" class="mobile-search-trigger">
                <span class="material-symbols-outlined">search</span>
            </button>

            <div class="header-navbar__content-barra">
                
                <div class="botoes-desktop" data-component="user-auth">
                    <div class="esconder-cedo">
                        <a href="{% url 'metodologia' %}" class="header-navbar__btn"><strong>Metodologia</strong></a>
                    </div>
                    <div class="esconder-cedo">
                        <a href="{% url 'sobre' %}" class="header-navbar__btn"><strong>Sobre</strong></a>
                    </div>
                    <div data-target="loginButton">
                        <a href="/" class="header-navbar__btn"><strong>Entrar</strong></a>
                    </div>
                    <div data-target="userMenu" style="display: none;">
                        <a href="#" class="header-navbar__btn"><strong>Minha Conta</strong></a>
                    </div>
                </div>

                <div class="mobile-emoji-decorative">
                    üü†
                </div>
            </div>

            <div id="sidebar-menu" class="sidebar-menu"> 
                <aside class="sidebar-menu__wrapper"> 
                    <div class="sidebar-menu__container">
                        <div class="main-menu">
                            <a href="/" class="main-menu__item" style="text-decoration: none; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">In√≠cio</a>
                            <div class="grupo-institucional sidebar-hidden-default">
                                <div class="separador"></div>
                                <span style="padding-left: 16px; font-size: 12px; color: #888; font-weight: bold;">INSTITUCIONAL</span>
                                <a href="{% url 'metodologia' %}" class="main-menu__item" style="text-decoration: none; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">Metodologia</a>
                                <a href="{% url 'sobre' %}" class="main-menu__item" style="text-decoration: none; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">Sobre</a>
                            </div>
                            <div class="grupo-conta sidebar-hidden-default">
                                <a href="#" class="main-menu__item" style="text-decoration: none; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">Minha Conta</a>
                            </div>
                            <div class="separador"></div>
                            <div style="padding-left: 16px; margin-bottom: 8px; font-size: 12px; color: #888; text-transform: uppercase; font-weight: bold;">Navega√ß√£o R√°pida</div>
                            {% for div in sidebar_divergencias %}
                                <a href="{% url 'divergencias' div.slug %}" class="main-menu__item" style="text-decoration: none; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">{{ div.nome }}</a>
                            {% empty %}{% endfor %}
                            <div class="separador"></div>
                            <a href="#" class="main-menu__item" style="text-decoration: none; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">Perfil</a>
                            <a href="{% url 'contato' %}" class="main-menu__item" style="text-decoration: none; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">Contato</a>
                            <a href="#" class="main-menu__item" style="text-decoration: none; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">Tema da P√°gina</a>
                        </div>
                    </div>
                </aside>
                <div class="sidebar-footer">
                    <div class="footer-links">
                        <a href="/sobre/">Sobre</a>   
                        <a href="#">Imprensa</a>
                        <a href="#">Direitos autorais</a>
                        <a href="#">Entre em contato</a>
                        <a href="#">Criadores</a>
                        <a href="#">Desenvolvedores</a>
                    </div>
                    <div class="footer-links">
                        <a href="#">Termos</a>
                        <a href="#">Privacidade</a>
                        <a href="#">Pol√≠tica e Seguran√ßa</a>
                        <a href="/metodologia/">Como funciona o Sonar</a>
                    </div>
                    <div class="footer-copyright">¬© 2025 Projeto Sonar</div>
                </div>
            </div> 
        <div id="sidebar-overlay" class="sidebar-overlay"></div>
    </header>

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />

    <main id="main">
        {% block conteudo %}
        {% endblock %}
    </main>

    <script>
    // --- BLOQUEIO DO BOT√ÉO VOLTAR NA HOME ---
        // Se a url for apenas "/" (Home), impede de voltar
        if (window.location.pathname === '/') {
            // Cria um estado no hist√≥rico para "prender" o usu√°rio
            history.pushState(null, null, window.location.href);
            
            // Sempre que ele tentar voltar (clicar no bot√£o do mouse ou do navegador)
            window.addEventListener('popstate', function () {
                // Empurra ele de volta para a p√°gina atual
                history.pushState(null, null, window.location.href);
            });
        }

        document.addEventListener("DOMContentLoaded", function() {
            // 1. Seleciona os elementos
            const botoes = document.querySelectorAll('[abrir-menu]');
            const menu = document.getElementById("sidebar-menu");
            const overlay = document.getElementById("sidebar-overlay");
            const main = document.getElementById("main");

            // --- L√ìGICA DE PERSIST√äNCIA (Local Storage) ---

            // Fun√ß√£o para aplicar o estado (Abrir ou Fechar)
            function setMenuState(isOpen, animate = true) {
                if (!animate) {
                    menu.style.transition = 'none';
                    main.style.transition = 'none';
                    overlay.style.transition = 'none';
                }

                if (isOpen) {
                    menu.classList.add('is-open');
                    overlay.classList.add('is-open');
                    main.classList.add('is-open');
                    
                    // --- ADICIONE ESTA LINHA: TRAVA O SCROLL ---
                    document.body.classList.add('no-scroll'); 
                } else {
                    menu.classList.remove('is-open');
                    overlay.classList.remove('is-open');
                    main.classList.remove('is-open');
                    
                    // --- ADICIONE ESTA LINHA: DESTRAVA O SCROLL ---
                    document.body.classList.remove('no-scroll');
                }

                localStorage.setItem('sidebarAberta', isOpen);

                if (!animate) {
                    void menu.offsetWidth; 
                    setTimeout(() => {
                        menu.style.transition = '';
                        main.style.transition = '';
                        overlay.style.transition = '';
                    }, 50);
                }
            }

            // 2. Verifica se j√° estava aberto antes
            const estadoSalvo = localStorage.getItem('sidebarAberta') === 'true';
            
            if (estadoSalvo) {
                setMenuState(true, false); 
            }

            // --- EVENTOS DE CLIQUE ---

            // 3. Clique nos bot√µes de abrir/fechar
            botoes.forEach(botao => {
                botao.addEventListener('click', () => {
                    const isCurrentlyOpen = menu.classList.contains('is-open');
                    setMenuState(!isCurrentlyOpen, true); 
                });
            });

            // 4. Clique no Overlay para fechar
            if (overlay) {
                overlay.addEventListener('click', () => {
                    setMenuState(false, true);
                });
            }

            // --- L√ìGICA DE LOGIN ---
            const component = document.querySelector('[data-component="user-auth"]');
            if (component) {
                const loginTarget = component.querySelector('[data-target="loginButton"]');
                const menuTarget = component.querySelector('[data-target="userMenu"]');
                const usuarioEstaLogado = true; // Mude para testar

                if (usuarioEstaLogado) {
                    if(loginTarget) loginTarget.style.display = 'none';
                    if(menuTarget) menuTarget.style.display = 'block';
                } else {
                    if(loginTarget) loginTarget.style.display = 'block';
                    if(menuTarget) menuTarget.style.display = 'none';
                }
            }
        });
    </script>

<script>
    // --- FUN√á√ïES GLOBAIS DO MODAL ---
    function abrirModalPreview(urlArquivo, tituloArquivo) {
        const modal = document.getElementById('modal-preview-global');
        if(modal) {
            document.getElementById('modal-iframe').src = urlArquivo;
            document.getElementById('modal-titulo-texto').innerText = tituloArquivo;
            document.getElementById('modal-btn-baixar').href = urlArquivo;
            modal.style.display = 'flex';
        }
    }

    function fecharModalPreview() {
        const modal = document.getElementById('modal-preview-global');
        if(modal) {
            modal.style.display = 'none';
            document.getElementById('modal-iframe').src = '';
        }
    }

    // Fechar ao clicar fora
    const modalEl = document.getElementById('modal-preview-global');
    if(modalEl){
        modalEl.addEventListener('click', function(e) {
            if (e.target === this) fecharModalPreview();
        });
    }

    // --- L√ìGICA DA BARRA DE PESQUISA ---
    document.addEventListener('DOMContentLoaded', function() {
        const input = document.getElementById('search-input');
        const resultsBox = document.getElementById('live-search-results');
        const searchContainer = document.querySelector('.search-container');
        let timeout = null;

        if (input) {
            input.addEventListener('input', function() {
                const query = this.value.trim();
                clearTimeout(timeout); 

                if (query.length === 0) {
                    fecharDropdown();
                    return;
                }

                timeout = setTimeout(() => {
                    fetch(`/busca-live/?q=${encodeURIComponent(query)}`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error("Erro no servidor (verifique urls.py)");
                            }
                            return response.json();
                        })
                        .then(data => {
                            let html = '';
                            
                            // Verifica se veio alguma coisa
                            const temDivergencia = data.divergencias && data.divergencias.length > 0;
                            const temMateria = data.materias && data.materias.length > 0;
                            const temPdf = data.pdfs && data.pdfs.length > 0;

                            if (!temDivergencia && !temMateria && !temPdf) {
                                resultsBox.innerHTML = '<div class="search-result-item" style="color: #aaa; text-align: center; padding: 15px;">Nenhum resultado encontrado.</div>';
                                abrirDropdown();
                                return;
                            }

                            // 1. SE√á√ÉO DIVERG√äNCIAS
                            if (temDivergencia) {
                                html += '<div class="search-category-title">Diverg√™ncias</div>';
                                data.divergencias.forEach(item => {
                                    html += `<a href="${item.url}" class="search-result-item"><strong>${item.nome}</strong></a>`;
                                });
                            }

                            // 2. SE√á√ÉO MAT√âRIAS
                            if (temMateria) {
                                html += '<div class="search-category-title">Mat√©rias</div>';
                                data.materias.forEach(item => {
                                    html += `
                                        <a href="${item.url}" class="search-result-item" style="display: flex; justify-content: space-between; align-items: center;">
                                            <div>
                                                <span style="font-weight: bold; color: #fff;">üìö ${item.nome}</span>
                                                <small style="display: block; color: var(--accent-color);">${item.info}</small>
                                            </div>
                                            <span class="material-symbols-outlined" style="font-size: 16px; color: #aaa;">arrow_forward</span>
                                        </a>`;
                                });
                            }

                            // 3. SE√á√ÉO PDFs
                            if (temPdf) {
                                html += '<div class="search-category-title">Arquivos PDF</div>';
                                data.pdfs.forEach(item => {
                                    // Aten√ß√£o: Usamos aspas simples escapadas nos argumentos da fun√ß√£o
                                    html += `
                                        <div class="search-result-item" style="cursor: pointer;" 
                                             onclick="abrirModalPreview('${item.url_arquivo}', '${item.titulo}')">
                                            üìÑ ${item.titulo}
                                            <small style="display:block; color: #94a3b8;">${item.info}</small>
                                        </div>`;
                                });
                            }

                            resultsBox.innerHTML = html;
                            abrirDropdown();
                        })
                        .catch(error => {
                            console.error("Erro na busca:", error);
                            resultsBox.innerHTML = '<div class="search-result-item" style="color: #ff6b6b; text-align: center;">Erro ao buscar. Verifique o console.</div>';
                            abrirDropdown();
                        });
                }, 300);
            });
        }

        function abrirDropdown() {
            resultsBox.classList.add('active');
            if(searchContainer) {
                searchContainer.style.borderRadius = '20px 20px 0 0';
                searchContainer.style.backgroundColor = 'rgba(15, 23, 42, 0.95)';
            }
        }

        function fecharDropdown() {
            resultsBox.classList.remove('active');
            if(searchContainer) {
                searchContainer.style.borderRadius = '50px';
                searchContainer.style.backgroundColor = '';
            }
        }

        // Fechar ao clicar fora
        document.addEventListener('click', function(e) {
            if (searchContainer && !searchContainer.contains(e.target)) {
                fecharDropdown();
            }
        });
    });

    document.addEventListener("DOMContentLoaded", function() {
        const mobileTrigger = document.getElementById('mobile-search-trigger');
        const searchForm = document.getElementById('search-form-container');
        const closeBtn = document.getElementById('close-search-mobile');
        const input = document.getElementById('search-input');
        
        // Selecionamos o container principal da navbar para controlar os outros elementos
        const navbarContent = document.querySelector('.header-navbar__content');

        // FUN√á√ÉO ABRIR
        mobileTrigger.addEventListener('click', function() {
            // Adiciona classe na busca
            searchForm.classList.add('mobile-active');
            // Adiciona classe no pai para esconder o resto
            navbarContent.classList.add('busca-aberta');
            
            input.focus(); 
        });

        // FUN√á√ÉO FECHAR
        function fecharBusca() {
            searchForm.classList.remove('mobile-active');
            navbarContent.classList.remove('busca-aberta');
        }

        closeBtn.addEventListener('click', fecharBusca);

        // Fechar clicando fora (opcional)
        document.addEventListener('click', function(event) {
            const isClickInside = searchForm.contains(event.target) || mobileTrigger.contains(event.target);
            if (!isClickInside && window.innerWidth < 470 && searchForm.classList.contains('mobile-active')) {
                fecharBusca();
            }
        });
    });
</script>


    <div id="modal-preview-global" class="modal-overlay" style="display: none;">
        <div class="modal-conteudo">
            <span class="fechar-modal" onclick="fecharModalPreview()">√ó</span>
            
            <div style="margin-bottom: 15px; padding-right: 30px;">
                <h3 id="modal-titulo-texto" style="margin: 0; color: #333; font-size: 1.2rem;">Visualiza√ß√£o</h3>
            </div>
            
            <iframe id="modal-iframe" src="" style="width: 100%; height: calc(100% - 80px); border: none; border-radius: 4px; background: #f1f1f1;"></iframe>
            
            <div style="position: absolute; bottom: 20px; right: 20px;">
                <a id="modal-btn-baixar" href="" download class="btn-baixar">
                    Baixar PDF
                </a>
            </div>
        </div>
    </div>
    </body>
</html>