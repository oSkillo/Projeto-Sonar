{% extends 'base.html' %}
{% load static %}
{% load custom_tags %}

{% block conteudo %}

<style>
    main::before {
        background-image: url('{% static "img/Sonar-Wallpapers-segunda-camada.jpg" %}') !important;
        background-position: center center !important;
        background-size: cover !important;
    }
</style>

<h1 style="text-align: center; margin-top: 30px; margin-bottom: 30px; -webkit-text-stroke: 1px rgb(2, 72, 97)">Qual a série do aluno?</h1>

<div class="cards-container modo-series">
    {% for item in items %}
        <a href="{% url 'listar_materias_com_grau' divergencia_slug grau_slug item.slug %}" class="card-opcao">
            {% if user|eh_admin %}
                <button class="btn-editar-card" 
                        onclick="event.preventDefault(); event.stopPropagation(); abrirModalEdicao('{% url 'editar_serie' item.id %}', '{{ item.nome }}', '{{ item.slug }}')">
                    <span class="material-symbols-outlined">edit</span>
                </button>
            {% endif %}
            <h3>{{ item.nome }}</h3>
        </a>
    {% endfor %}
    </div>

<div class="barra-botoes-fixa">
    <a href="javascript:history.back()" class="btn-voltar">← Voltar</a>
    {% if user|eh_admin %}
        <a onclick="abrirModalSerie()" class="btn-adicionar">+ Adicionar</a>
    {% endif %}
</div>

<div style="height: 100px;"></div>

<div id="modal-criar-serie" class="modal-overlay" style="display: none;">
    <div class="modal-conteudo card-login" style="max-width: 500px; height: auto;">
        <span class="fechar-modal" onclick="fecharModalSerie()">×</span>
        <h2 style="text-align: center; color: #fff; margin-bottom: 20px;">Nova Série</h2>
        <form action="{% url 'criar_serie' %}" method="POST">
            {% csrf_token %}
            
            <div class="campo-input" style="margin-bottom: 15px;">
                <label>Nome da Série:</label>
                <input type="text" 
                    name="nome" 
                    id="id_nome_serie" 
                    class="input-estilizado" 
                    placeholder="Ex: 6º Ano Fundamental" 
                    required 
                    onkeyup="gerarSlug('id_nome_serie', 'id_slug_serie')">
            </div>

            <div class="campo-input" style="margin-bottom: 15px;">
                <label style="font-size: 0.8rem; color: #aaa;">Link (Slug):</label>
                <input type="text" 
                    name="slug" 
                    id="id_slug_serie" 
                    class="input-estilizado" 
                    placeholder="Ex: 6-ano-fundamental" 
                    readonly 
                    style="background: rgba(255,255,255,0.05); color: #888; cursor: default;">
            </div>

            {% if divergencia %}
                <input type="hidden" name="divergencia_id" value="{{ divergencia.id }}">
            {% endif %}

            {% if grau %}
                <input type="hidden" name="grau_id" value="{{ grau.id }}">
            {% endif %}

            <button type="submit" class="btn-entrar-login" style="width: 100%;">Salvar</button>
        </form>
    </div>
</div>
<script>
    function abrirModalSerie() { document.getElementById('modal-criar-serie').style.display = 'flex'; }
    function fecharModalSerie() { document.getElementById('modal-criar-serie').style.display = 'none'; }
    // (Copie a função gerarSlug aqui também se não estiver num arquivo JS global)
    function gerarSlug(origemId, destinoId) {
        const nome = document.getElementById(origemId).value;
        const slug = nome.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '-').replace(/[^\w\-]+/g, '').replace(/\-\-+/g, '-').replace(/^-+/, '').replace(/-+$/, '');
        document.getElementById(destinoId).value = slug;
    }
</script>

<div id="modal-editar-generico" class="modal-overlay" style="display: none;">
    <div class="modal-conteudo card-login" style="max-width: 500px; height: auto;">
        <span class="fechar-modal" onclick="fecharModalEdicao()">×</span>
        <h2 style="text-align: center; color: #fff; margin-bottom: 20px;">Editar Série</h2>
        <form id="form-edicao" method="POST">
            {% csrf_token %}
            <div class="campo-input" style="margin-bottom: 15px;">
                <label>Nome:</label>
                <input type="text" name="nome" id="edit_nome" class="input-estilizado">
            </div>
            <div class="campo-input" style="margin-bottom: 15px;">
                <label>Slug:</label>
                <input type="text" name="slug" id="edit_slug" class="input-estilizado">
            </div>
            <button type="submit" class="btn-entrar-login" style="width: 100%;">Salvar</button>
            <button type="submit" name="deletar" value="true" class="btn-excluir" onclick="return confirm('Apagar esta série?')">Excluir</button>
        </form>
    </div>
</div>
<script>
    function abrirModalEdicao(url, nome, slug) {
        document.getElementById('form-edicao').action = url;
        document.getElementById('edit_nome').value = nome;
        document.getElementById('edit_slug').value = slug;
        document.getElementById('modal-editar-generico').style.display = 'flex';
    }
    function fecharModalEdicao() { document.getElementById('modal-editar-generico').style.display = 'none'; }
</script>
{% endblock %}