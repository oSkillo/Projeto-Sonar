{% extends 'base.html' %}
{% load custom_tags %}
{% load static %}

{% block conteudo %}

<style>
    main::before {
        background-image: url('{% static "img/Sonar-Wallpaper-primeira-camada-sem-submarino.jpg" %}') !important;
        background-position: center bottom !important;
    }
</style>

{% if not user.is_authenticated %}
    <div class="landing-container">
        </div>

{% else %}

    <h1 style="text-align: center; margin-top: 2%; -webkit-text-stroke: 1px rgb(2, 72, 97)">Escolha a Diverg√™ncia</h1>

    <div class="cards-container cards-verticais">
        
        {% for item in items %}
            <a href="{% url 'divergencias' item.slug %}" class="card-opcao">
                {% if user|eh_admin %}
                    <button class="btn-editar-card" 
                            onclick="event.preventDefault(); event.stopPropagation(); abrirModalEdicao('{% url 'editar_divergencia' item.id %}', '{{ item.nome }}', '{{ item.slug }}')">
                        <span class="material-symbols-outlined">edit</span>
                    </button>
                {% endif %}        

                {% if item.imagem %}
                    <img src="{{ item.imagem.url }}" alt="{{ item.nome }}" style="max-height: 60px;">
                {% endif %}
                <h3>{{ item.nome }}</h3>
            </a>
        {% endfor %}

        <a href="{% url 'outras' %}" class="card-opcao">
            <h3> üß¨ Outras Diverg√™ncias</h3>
        </a>
        
    </div>
    {% if user|eh_admin %}
        <div class="barra-botoes-fixa">
            <a onclick="abrirModalDivergencia()" class="btn-adicionar">+ Adicionar</a>
        </div>
    {% endif %}
<div style="height: 100px;"></div>
{% endif %}

<div id="modal-criar-divergencia" class="modal-overlay" style="display: none;">
    <div class="modal-conteudo card-login" style="max-width: 500px; height: auto;">
        <span class="fechar-modal" onclick="fecharModalDivergencia()">√ó</span>
        
        <h2 style="text-align: center; margin-bottom: 20px; color: #fff;">Nova Diverg√™ncia</h2>
        
        <form action="{% url 'criar_divergencia' %}" method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            
            <div class="campo-input" style="margin-bottom: 15px;">
                <label for="id_nome_div">Nome:</label>
                <input type="text" name="nome" id="id_nome_div" class="input-estilizado" required onkeyup="gerarSlugAutomatico()">
            </div>

            <div class="campo-input" style="margin-bottom: 15px;">
                <label for="id_slug_div">Slug (Nome na URL):</label>
                <input type="text" name="slug" id="id_slug_div" class="input-estilizado" required>
                <small style="color: #aaa; font-size: 0.8rem;">Ex: autismo-leve (sem espa√ßos, min√∫sculo)</small>
                <br>
                <small style="color: #aaa; font-size: 0.8rem;">Cuidado para n√£o criar o mesmo Slug mais de 1 vez</small>
            </div>

            <div class="campo-input" style="margin-bottom: 15px;">
                <label for="id_imagem">Imagem:</label>
                <input type="file" name="imagem" id="id_imagem" class="input-estilizado" style="padding: 10px;">
            </div>

            <div style="display: flex; gap: 20px; margin-bottom: 25px; margin-top: 20px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" name="tem_graus" id="id_tem_graus" style="transform: scale(1.5);">
                    <label for="id_tem_graus" style="margin: 0; cursor: pointer;">Tem graus?</label>
                </div>

                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" name="destaque_home" id="id_destaque_home" style="transform: scale(1.5);">
                    <label for="id_destaque_home" style="margin: 0; cursor: pointer;">Home?</label>
                </div>
            </div>

            <div style="text-align: center;">
                <button type="submit" class="btn-entrar-login" style="width: 100%;">Salvar Diverg√™ncia</button>
            </div>
        </form>
    </div>
</div>

<div id="modal-editar-generico" class="modal-overlay" style="display: none;">
    <div class="modal-conteudo card-login" style="max-width: 500px; height: auto;">
        
        <span class="fechar-modal" onclick="fecharModalEdicao()">√ó</span>
       
        <h2 style="text-align: center; color: #fff; margin-bottom: 20px;">Editar Item</h2>
        
        <form id="form-edicao" method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            
            <div class="campo-input" style="margin-bottom: 15px;">
                <label>Nome:</label>
                <input type="text" name="nome" id="edit_nome" class="input-estilizado">
            </div>

            <div class="campo-input" style="margin-bottom: 15px;">
                <label>Slug (URL):</label>
                <input type="text" name="slug" id="edit_slug" class="input-estilizado">
            </div>

            <button type="submit" class="btn-entrar-login" style="width: 100%;">Salvar Altera√ß√µes</button>

            <button type="submit" name="deletar" value="true" class="btn-excluir" onclick="return confirm('Tem certeza que deseja apagar este item?')">
                Excluir
            </button>
        </form>
    </div>
</div>

<script>
    // --- FUN√á√ïES DE CRIAR ---
    function abrirModalDivergencia() {
        document.getElementById('modal-criar-divergencia').style.display = 'flex';
    }

    function fecharModalDivergencia() {
        document.getElementById('modal-criar-divergencia').style.display = 'none';
    }

    // Fechar ao clicar no fundo escuro (criar)
    document.getElementById('modal-criar-divergencia').addEventListener('click', function(e) {
        if (e.target === this) fecharModalDivergencia();
    });

    // Gera o slug automaticamente enquanto digita o nome
    function gerarSlugAutomatico() {
        const nome = document.getElementById('id_nome_div').value;
        const slug = nome.toLowerCase()
            .normalize('NFD').replace(/[\u0300-\u036f]/g, "") // Tira acento
            .replace(/\s+/g, '-') // Espa√ßo vira h√≠fen
            .replace(/[^\w\-]+/g, '') // Tira caracteres estranhos
            .replace(/\-\-+/g, '-') // Tira h√≠fen duplicado
            .replace(/^-+/, '').replace(/-+$/, ''); // Limpa pontas
        
        document.getElementById('id_slug_div').value = slug;
    }

    // --- FUN√á√ïES DE EDITAR ---
    function abrirModalEdicao(urlAction, nomeAtual, slugAtual) {
        // 1. Pega o formul√°rio de edi√ß√£o
        const form = document.getElementById('form-edicao');
        
        // 2. Define para onde ele vai enviar os dados (ex: /editar-divergencia/5/)
        form.action = urlAction;
        
        // 3. Preenche os campos com o que j√° existe
        document.getElementById('edit_nome').value = nomeAtual;
        document.getElementById('edit_slug').value = slugAtual;
        
        // 4. Mostra o modal
        document.getElementById('modal-editar-generico').style.display = 'flex';
    }

    function fecharModalEdicao() {
        document.getElementById('modal-editar-generico').style.display = 'none';
    }
</script>

{% endblock %}